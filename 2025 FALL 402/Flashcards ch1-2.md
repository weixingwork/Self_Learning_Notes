ğŸ”¹**è¿›ç¨‹ (Process)**

**Q:** ä»€ä¹ˆæ˜¯è¿›ç¨‹ (process)ï¼Ÿ

**A:** æ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œæ˜¯æ“ä½œç³»ç»Ÿè¿›è¡Œ**èµ„æºåˆ†é…ä¸è°ƒåº¦**çš„åŸºæœ¬å•ä½ï¼›æ‹¥æœ‰**ç‹¬ç«‹çš„åœ°å€ç©ºé—´**ï¼ˆä»£ç æ®µ/æ•°æ®æ®µ/å †/æ ˆï¼‰ã€æ‰“å¼€æ–‡ä»¶è¡¨ã€ä¿¡å·å¤„ç†ç­‰ã€‚

  

**Q:** ä»€ä¹ˆæ˜¯ PCB (Process Control Block)ï¼Ÿ

**A:** å†…æ ¸ç”¨æ¥è®°å½•è¿›ç¨‹çŠ¶æ€çš„ç»“æ„ï¼Œå« PIDã€å¯„å­˜å™¨å¿«ç…§ã€è°ƒåº¦ä¿¡æ¯ã€æ‰“å¼€æ–‡ä»¶æŒ‡é’ˆã€é€€å‡ºç ã€çˆ¶å­å…³ç³»ç­‰ã€‚çˆ¶è¿›ç¨‹é€šè¿‡å®ƒçŸ¥é“å­è¿›ç¨‹çš„**return code**ã€‚

  

**Q:** ä¸ºä»€ä¹ˆæ‰§è¡Œå‘½ä»¤ï¼ˆå¦‚ lsï¼‰æ—¶ shell è¦å…ˆ fork()ï¼Ÿ

**A:** ä¸ºäº†è®© shell è‡ªå·±ç»§ç»­å­˜åœ¨ä¸äº¤äº’ã€‚è‹¥ç›´æ¥ exec lsï¼Œshell ä¼šè¢«**æ›¿æ¢**ï¼Œäº¤äº’ä¸­æ–­ï¼›fork() å…ˆå¤åˆ¶å‡ºä¸€ä¸ª**å­è¿›ç¨‹**ï¼Œå†åœ¨å­è¿›ç¨‹é‡Œ exec æ–°ç¨‹åºã€‚

---

ğŸ”¹**åœ°å€ç©ºé—´ & å†…æ ¸åˆ‡æ¢ (trap / system call)**

**Q:** ä»€ä¹ˆæ˜¯ system callï¼Ÿ

**A:** ç”¨æˆ·æ€ç¨‹åºé€šè¿‡**é™·å…¥æŒ‡ä»¤ï¼ˆtrapï¼‰**è¿›å…¥å†…æ ¸æ€ä»¥è¯·æ±‚æœåŠ¡ï¼ˆå¦‚ read/write/open/fork/exec/wait/exitï¼‰ã€‚åº“å‡½æ•°ä¼šåœ¨åº•å±‚å‘å‡º trap æŒ‡ä»¤ã€‚

  

**Q:** è°ƒç”¨ write(fd, buf, len) æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

**A:** ç”¨æˆ·æ€â†’trapâ†’å†…æ ¸æ€ï¼Œå†…æ ¸æ ¹æ® fd æ‰¾åˆ°å†…æ ¸â€œæ–‡ä»¶å¯¹è±¡â€ï¼ŒæŒ‰æƒé™å’Œ**æ–‡ä»¶åç§»(cursor)** æŠŠæ•°æ®å†™åˆ°ç›®æ ‡ï¼›è‹¥é”™è¯¯è¿”å› -1 å¹¶è®¾ç½® errnoã€‚

  

**Q:** ç”¨æˆ·/å†…æ ¸åœ°å€ç©ºé—´å¦‚ä½•å…±å­˜ï¼Ÿ

**A:** æ¯ä¸ªè¿›ç¨‹æœ‰â€œç”¨æˆ·éƒ¨åˆ†â€ï¼ŒåŒæ—¶æ˜ å°„**åŒä¸€å¥—å†…æ ¸**ï¼›é™·å…¥å†…æ ¸åï¼Œä»æ˜¯**åŒä¸€æ¡æ‰§è¡Œçº¿**åœ¨è¯¥è¿›ç¨‹çš„**å†…æ ¸æ ˆ**ä¸Šè¿è¡Œï¼Œå†è¿”å›ç”¨æˆ·æ€ç»§ç»­ã€‚

---

ğŸ”¹**åˆ›å»º/æ›¿æ¢/ç»ˆæ­¢ è¿›ç¨‹ï¼šfork/exec/exit/wait**

**Q:** fork() çš„ä½œç”¨ä¸è¿”å›å€¼ï¼Ÿ

**A:** åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼ˆå‡ ä¹çˆ¶è¿›ç¨‹çš„æ‹·è´ï¼‰ã€‚è¿”å›ä¸¤æ¬¡ï¼š

- çˆ¶è¿›ç¨‹å¾—åˆ°**å­è¿›ç¨‹ PID**ï¼ˆ>0ï¼‰ï¼›
    
- å­è¿›ç¨‹è¿”å›**0**ã€‚
```
pid_t pid = fork();
if (pid == 0) { /* child path */ }
else if (pid > 0) { /* parent path, pidæ˜¯å­©å­PID */ }
else { /* -1: forkå¤±è´¥ */ }
```
**Q:** if ((pid = fork()) == 0) { ... } è¿™å¥æ€ä¹ˆè¯»ï¼Ÿ

**A:** å…ˆè°ƒç”¨ fork() å¹¶**èµ‹å€¼**ç»™ pidï¼Œéšååˆ¤æ–­æ˜¯å¦ç­‰äº 0ã€‚åªæœ‰**å­è¿›ç¨‹**ä¼šè¿›å…¥ if åˆ†æ”¯ï¼›çˆ¶è¿›ç¨‹è·³è¿‡ ifã€‚

  

**Q:** exec() å¹²ä»€ä¹ˆï¼Ÿä¸ fork() å¦‚ä½•é…åˆï¼Ÿ

**A:** exec* å®¶æ—ç”¨**æ–°ç¨‹åº**æ›¿æ¢å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼ˆPID ä¸å˜ï¼‰ã€‚å¸¸ç”¨æ¨¡å¼ï¼šçˆ¶ fork() -> å­ exec()ã€‚
```
execl("/bin/ls", "ls", "-l", (char*)0);  // argv[0] é€šå¸¸å†™ç¨‹åºå
```
**Q:** execl å‚æ•°ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ª "primes"ï¼Ÿ

**A:** ç¬¬ä¸€ä¸ªæ˜¯**è·¯å¾„**ï¼Œç¬¬äºŒä¸ªæ˜¯ argv[0]ï¼ˆç¨‹åºåï¼‰ï¼Œåæ¥å„å‚æ•°ï¼Œæœ€åä»¥ NULL ç»“æŸã€‚

  

**Q:** exit(n) ä¸ä» main è¿”å›çš„å…³ç³»ï¼Ÿ

**A:** main çš„ return n; æœ€ç»ˆä¼šè°ƒç”¨ exit(n)ã€‚åœ¨å¤šçº¿ç¨‹ç¨‹åºé‡Œï¼Œexit() ä¼š**ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹**ï¼ˆæ‰€æœ‰çº¿ç¨‹ï¼‰ã€‚

  

**Q:** wait() / waitpid() ä½œç”¨ä¸è¦ç‚¹ï¼Ÿ

**A:** **é˜»å¡**ç­‰å¾…å­è¿›ç¨‹ç»“æŸå¹¶**å›æ”¶**å…¶ PCBï¼Œå¾—åˆ°é€€å‡ºçŠ¶æ€ï¼š
```
int st; pid_t c = wait(&st);
if (WIFEXITED(st)) printf("code=%d\n", WEXITSTATUS(st));
```
- æœ‰å¤šä¸ªå­è¿›ç¨‹æ—¶ï¼Œwait() å›æ¥çš„æ˜¯**ä»»æ„ä¸€ä¸ª**å·²ç»“æŸçš„å­è¿›ç¨‹ã€‚
    
- ä¸ wait ä¼šäº§ç”Ÿ**åƒµå°¸è¿›ç¨‹**ã€‚
    

  

**Q:** åƒµå°¸è¿›ç¨‹ (zombie) ä¸ reparentingï¼Ÿ

**A:** å­è¿›ç¨‹ç»“æŸè€Œçˆ¶è¿›ç¨‹æœª wait â†’ å­ç•™åœ¨**åƒµå°¸**çŠ¶æ€ï¼ˆä»…ä¿ç•™ PID/é€€å‡ºç ï¼‰ç­‰è¢«å›æ”¶ã€‚è‹¥çˆ¶å…ˆæ­»ï¼Œå­¤å„¿ä¼šè¢« PID=1ï¼ˆinit/systemdï¼‰æ¥ç®¡å¹¶æ”¶å‰²ï¼ˆ**reparenting**ï¼‰ã€‚

  

**Q:** PID ä¼šå¤ç”¨å—ï¼Ÿ

**A:** ä¼šï¼Œä½† OS ä¼šå°½é‡**å»¶è¿Ÿ**å¤ç”¨ï¼Œé¿å…ä¸åƒµå°¸/æœªæ”¶å‰²è®°å½•æ··æ·†ã€‚

---

ğŸ”¹**æ–‡ä»¶ & I/Oï¼ˆfd/å¥æŸ„/é‡å®šå‘/å¯¹è±¡/è¡¨ï¼‰**

**Q:** ä»€ä¹ˆæ˜¯æ–‡ä»¶æè¿°ç¬¦ (fd) ä¸â€œå¥æŸ„ (handle)â€ï¼Ÿ

**A:** fd æ˜¯è¿›ç¨‹å¯è§çš„**æ•´å‹ç´¢å¼•**ï¼ŒæŒ‡å‘è¿›ç¨‹çš„**æ–‡ä»¶æè¿°ç¬¦è¡¨**ä¸­çš„ä¸€ä¸ªâ€œæ–‡ä»¶å¯¹è±¡â€ï¼›handle æ³›æŒ‡ç”±å†…æ ¸ç®¡ç†å¯¹è±¡çš„**ç´¢å¼•**ã€‚

  

**Q:** æ ‡å‡† fd æ˜¯å“ªäº›ï¼Ÿ

**A:** 0=stdinï¼Œ1=stdoutï¼Œ2=stderrã€‚

  

**Q:** â€œæœ€å°ç©ºé—² fd åˆ†é…â€è§„åˆ™ï¼Ÿ

**A:** open() æ€»è¿”å›è¯¥è¿›ç¨‹ä¸­**æœ€å°ç¼–å·**çš„ç©ºé—² fdã€‚
```
close(1);                      // é‡Šæ”¾stdout
int fd = open("out.txt", O_WRONLY|O_CREAT|O_TRUNC, 0644);
// è‹¥æˆåŠŸï¼Œfd é€šå¸¸=1ï¼Œå®ç°äº† stdout é‡å®šå‘
```
**Q:** å¦‚ä½•åœ¨å­è¿›ç¨‹ä¸­æŠŠ stdout é‡å®šå‘åˆ°æ–‡ä»¶å† execï¼Ÿ

**A:**
```
if (fork() == 0) {
  close(1);
  if (open("/path/out", O_WRONLY|O_CREAT|O_TRUNC, 0644) == -1) _exit(1);
  execl("/bin/ls", "ls", (char*)0);
  _exit(1);
}
wait(0);
```
ç­‰ä»· shellï¼šls > /path/outã€‚**æ‰“å¼€çš„ fd ä¼šåœ¨ exec åç»§ç»­å­˜åœ¨**ï¼ˆç§°â€œæ‰©å±•åœ°å€ç©ºé—´â€éš exec ä¿ç•™ï¼‰ã€‚

  

**Q:** open/read/write/close åŸºæœ¬ç”¨æ³•ï¼Ÿ

**A:**
```
int fd = open("file", O_RDWR);              // O_RDONLY/O_WRONLY/O_RDWR
char buf[1024]; ssize_t n = read(fd, buf, sizeof(buf));
if (write(fd, buf, n) == -1) perror("write");
close(fd);
```
perror() ä¼šåŸºäº errno æ‰“å°å‡ºé”™åŸå› ã€‚

  

**Q:** FILE*ï¼ˆå¦‚ printf/fprintfï¼‰ä¸ fd çš„å·®åˆ«ï¼Ÿ

**A:** FILE* æ˜¯**C æ ‡å‡†åº“ç¼“å†²æµ**ï¼›fd æ˜¯å†…æ ¸çº§**éç¼“å†²**æ¥å£ã€‚fprintf(stdout,...) è¿‘ä¼¼ write(1,...)ï¼Œä½†å‰è€…æœ‰ç”¨æˆ·æ€ç¼“å†²ã€‚

  

**Q:** æ–‡ä»¶å¯¹è±¡é‡Œéƒ½å­˜ä»€ä¹ˆï¼Ÿ

**A:** è®¿é—®æ¨¡å¼ï¼ˆå¦‚ O_RDONLYï¼‰ã€æ–‡ä»¶åç§»ï¼ˆcursorï¼‰ã€å¼•ç”¨è®¡æ•°ã€æŒ‡å‘ inode çš„æŒ‡é’ˆç­‰ã€‚**ä¸Šä¸‹æ–‡ä¿¡æ¯åœ¨å†…æ ¸ï¼Œä¸å¯è¢«ç”¨æˆ·ç¨‹åºéšæ„ç¯¡æ”¹**ã€‚

---

ğŸ”¹**å¤šçº¿ç¨‹ (POSIX Threads)**

**Q:** å¦‚ä½•åˆ›å»ºçº¿ç¨‹ï¼Ÿå‡½æ•°åŸå‹è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ

**A:**
```
int pthread_create(pthread_t *t, const pthread_attr_t *attr,
                   void *(*start)(void*), void *arg);
```
çº¿ç¨‹å…¥å£å¿…é¡»æ˜¯ void* (*)(void*)ï¼š
```
void *worker(void *arg) { /* ... */ return NULL; }
pthread_t tid; pthread_create(&tid, NULL, worker, arg);
```
**Q:** ä¼ å‚ (void*)i ä¸åœ°å€ä¼ å‚çš„å‘ï¼Ÿ

**A:** (void*)i æŠŠæ•´æ•°å¼ºè½¬ä¸ºæŒ‡é’ˆï¼Œ**64 ä½ä¸‹æœ‰é£é™©**ã€‚æ›´å®‰å…¨ï¼šä¸ºæ¯ä¸ªçº¿ç¨‹**å•ç‹¬åˆ†é…**å®å‚å¹¶ä¼ åœ°å€ï¼š
```
int *pi = malloc(sizeof *pi); *pi = i;
pthread_create(&tid,0,worker,pi);  // workeré‡Œç”¨å®Œfree(pi)
```
**Q:** å¤šå‚æ•°æ€ä¹ˆä¼ ï¼Ÿ

**A:** å®šä¹‰ç»“æ„ä½“ï¼š
```
typedef struct { int a, b; } two_ints_t;
two_ints_t *p = malloc(sizeof *p); *p=(two_ints_t){x,y};
pthread_create(&tid,0,worker,p);
void *worker(void *arg){ two_ints_t *p=arg; /*...*/ free(p); return NULL; }
```
**Q:** ä¼ å±€éƒ¨å˜é‡åœ°å€ä¸ºä½•æ˜“å‡º**å†…å­˜ç ´å (memory corruption)**ï¼Ÿ

**A:** è‹¥åˆ›å»ºçº¿ç¨‹åå‡½æ•°**æå‰è¿”å›**ï¼Œè¯¥å±€éƒ¨å˜é‡æ‰€åœ¨çš„**æ ˆå¸§æ— æ•ˆ**ï¼Œçº¿ç¨‹é‡Œä»åœ¨ç”¨**æ‚¬ç©ºæŒ‡é’ˆ** â†’ è¯»å†™éšæœºå†…å­˜å¯¼è‡´å´©æºƒ/æ•°æ®é”™ä¹±ã€‚è§£å†³ï¼šåœ¨è¿”å›å‰ pthread_join() æˆ–ä½¿ç”¨ mallocã€‚

  

**Q:** pthread_join() ä¸çº¿ç¨‹è¿”å›å€¼ï¼Ÿ

**A:** é˜»å¡ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œå¹¶å¯å–å›å…¶ void* è¿”å›å€¼ï¼š
```
void *ret; pthread_join(tid,&ret);
```
ä¸€ä¸ªçº¿ç¨‹**åªèƒ½è¢« join ä¸€æ¬¡**ï¼›æ²¡äºº join çš„ç»“æŸçº¿ç¨‹ä¼šä¿ç•™è¿”å›å€¼/ID/æ ˆä¿¡æ¯ï¼Œç±»ä¼¼**åƒµå°¸çº¿ç¨‹**ï¼Œç›´åˆ°è¢« join æˆ– detachã€‚

  

**Q:** pthread_exit() vs return vs è¿›ç¨‹ exit()ï¼Ÿ

**A:** pthread_exit(v) å’Œ return (void*)v; éƒ½ç»“æŸ**å½“å‰çº¿ç¨‹**å¹¶æŠŠå€¼äº¤ç»™ joinã€‚exit() ä¼šç»“æŸ**æ•´ä¸ªè¿›ç¨‹**ï¼ˆæ‰€æœ‰çº¿ç¨‹ï¼‰ï¼Œå¸¸ç”± main çš„ return éšå¼è§¦å‘ã€‚

  

**Q:** ä¸»çº¿ç¨‹æƒ³é€€å‡ºä½†ä¿ç•™å…¶ä»–çº¿ç¨‹ç»§ç»­è·‘ï¼Ÿ

**A:** åœ¨ main é‡Œè°ƒç”¨ pthread_exit(NULL);ï¼ˆè€Œä¸æ˜¯ returnï¼‰ï¼Œè¿™æ ·è¿›ç¨‹ä¸é€€å‡ºï¼Œå…¶ä»–çº¿ç¨‹å¯ç»§ç»­ã€‚

  

**Q:** ä»€ä¹ˆæ˜¯åˆ†ç¦»çº¿ç¨‹ (detached thread)ï¼Ÿ

**A:** è°ƒ pthread_detach(tid) çš„çº¿ç¨‹**æ— éœ€ join**ï¼Œç»“æŸå³è‡ªåŠ¨å›æ”¶èµ„æºã€‚é€‚åˆâ€œfire-and-forgetâ€ã€‚**å·² detach çš„çº¿ç¨‹ä¸èƒ½å† join**ã€‚

  

**Q:** çº¿ç¨‹æ ˆå¤šå¤§ï¼Ÿå¦‚ä½•è®¾ç½®ï¼Ÿ

**A:** Linux/glibc é»˜è®¤å¸¸è§**8MB**ã€‚å¯ç”¨å±æ€§è®¾ç½®ï¼š
```
pthread_attr_t a; pthread_attr_init(&a);
pthread_attr_setstacksize(&a, 20*1024*1024);   // ä¾‹å¦‚20MB
pthread_create(&tid, &a, worker, arg);
pthread_attr_destroy(&a);
```
**çº¿ç¨‹å¤š**â†’è€ƒè™‘å‡å°æ ˆï¼›**æ·±é€’å½’/å¤§å±€éƒ¨æ•°ç»„**â†’å¢å¤§æ ˆã€‚

  

**Q:** æ ˆæº¢å‡º (stack overflow) å¦‚ä½•äº§ç”Ÿä¸é¿å…ï¼Ÿ

**A:** é€’å½’è¿‡æ·±æˆ–å¤§å±€éƒ¨æ•°ç»„è¶…æ ˆé™è§¦å‘æº¢å‡ºã€‚é¿å…ï¼šæ§åˆ¶é€’å½’æ·±åº¦ï¼›æŠŠå¤§æ•°ç»„æ”¾**å †**ï¼›å¿…è¦æ—¶**å¢å¤§çº¿ç¨‹æ ˆ**ã€‚

  

**Q:** ä¸ºä»€ä¹ˆå¤šçº¿ç¨‹å¯èƒ½æ›´å¿«ï¼Ÿ

**A:** èƒ½æŠŠ**è®¡ç®—/IO**å¹¶è¡Œåœ¨å¤šä¸ª CPU æ ¸ã€æˆ–åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾… IO æ—¶è®©åˆ«çš„çº¿ç¨‹**æ— æ„Ÿåˆ‡æ¢**ç»§ç»­ç®—/åš IOã€‚æ³¨æ„ï¼šéœ€è¦**è¶³å¤Ÿçš„å¯å¹¶è¡Œå·¥ä½œ**ä¸**åˆç†åŒæ­¥**ï¼Œå¦åˆ™é”ç«äº‰ä¼šæŠµæ¶ˆæ”¶ç›Šã€‚

  

**Q:** ç»å…¸å¹¶è¡Œä¾‹ï¼šçŸ©é˜µä¹˜æ³•æŒ‰è¡Œå¹¶è¡Œï¼Ÿ

**A:** ä¸º C çš„æ¯ä¸€è¡Œå¼€ä¸€ä¸ªçº¿ç¨‹ï¼š
```
void* matrow(void* arg){ int row=(int)(intptr_t)arg; /* è®¡ç®—C[row][*] */ return 0; }
for(int i=0;i<M;++i) pthread_create(&th[i],0,matrow,(void*)(intptr_t)i);
for(int i=0;i<M;++i) pthread_join(th[i],0);
```
ï¼ˆæ³¨æ„å®‰å…¨åœ°ä¼ å‚ï¼š(intptr_t) æˆ–ä¼ åœ°å€ï¼‰

---

ğŸ”¹**å¹¶å‘é”™è¯¯ä¸åŒæ­¥ (Race / Mutex / Critical Section)**

**Q:** ä»€ä¹ˆæ˜¯ race conditionï¼ˆç«æ€æ¡ä»¶ï¼‰ï¼Ÿ

**A:** æœ€ç»ˆç»“æœå–å†³äºå¤šä¸ªæ‰§è¡Œå•å…ƒçš„**äº¤é”™é¡ºåº**ï¼›ä¾‹å¦‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åš x = x + 1 ä¼šä¸¢å¤±æ›´æ–°ã€‚

  

**Q:** ä»€ä¹ˆæ˜¯ data raceï¼ˆæ•°æ®ç«äº‰ï¼‰ï¼Ÿ

**A:** å¤šçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€å†…å­˜åœ°å€ï¼Œè‡³å°‘ä¸€ä¸ªæ˜¯**å†™**ï¼Œä¸”æ— åŒæ­¥ï¼›åœ¨ C/C++ å†…å­˜æ¨¡å‹é‡Œå±äº**æœªå®šä¹‰è¡Œä¸º**ã€‚

  

**Q:** ä»€ä¹ˆæ˜¯ä¸´ç•ŒåŒº (critical section)ï¼Ÿ

**A:** è®¿é—®**å…±äº«å¯å˜çŠ¶æ€**çš„ä»£ç ç‰‡æ®µï¼Œå¿…é¡»ä¿è¯**äº’æ–¥**ã€‚

  

**Q:** å¦‚ä½•ç”¨ mutex ä¿æŠ¤ä¸´ç•ŒåŒºï¼Ÿ

**A:**
```
pthread_mutex_t m = PTHREAD_MUTEX_INITIALIZER;
pthread_mutex_lock(&m);
x = x + 1;             // ä¸´ç•ŒåŒº
pthread_mutex_unlock(&m);
```
ä¿è¯åŒä¸€æ—¶åˆ»**åªæœ‰ä¸€ä¸ªçº¿ç¨‹**æ‰§è¡Œè¢«ä¿æŠ¤ä»£ç ï¼Œæ¶ˆé™¤ data raceã€‚

---

ğŸ”¹**I/O é‡å®šå‘ï¼ˆè¿›ç¨‹å†…å®ç°ï¼‰**

**Q:** ç”¨ç³»ç»Ÿè°ƒç”¨æŠŠç¨‹åºè¾“å‡ºå†™åˆ°æ–‡ä»¶ï¼ˆç­‰ä»· > fileï¼‰æ€ä¹ˆå†™ï¼Ÿ

**A:**
```
if (fork()==0) {
  close(1);
  if (open("out", O_WRONLY|O_CREAT|O_TRUNC, 0644) == -1) _exit(1);
  execl("/home/bc/bin/primes","primes","300",(char*)0);
  _exit(1);
}
while (wait(0) > 0) {}   // å›æ”¶å­è¿›ç¨‹
```
è¦ç‚¹ï¼šclose(1) å…ˆè…¾å‡º 1ï¼›open æ–°æ–‡ä»¶æ‹¿åˆ°æœ€å°å¯ç”¨ fdâ†’é€šå¸¸æ˜¯ 1ï¼›exec åå†™ 1 å°±æ˜¯å†™æ–‡ä»¶ã€‚

---

ğŸ”¹**ç¼–è¯‘/é“¾æ¥ pthread ç¨‹åº**

**Q:** gcc å¦‚ä½•ç¼–è¯‘ pthread ç¨‹åºï¼Ÿ

**A:** -pthreadï¼ˆä¼˜é€‰ï¼‰æˆ– -lpthreadï¼š
```
gcc -o app app.c -pthread
```
-pthread æ—¢å¯ç”¨ç¼–è¯‘æœŸçš„çº¿ç¨‹å®ï¼Œä¹Ÿåœ¨é“¾æ¥æ—¶å¸¦ä¸Š pthread åº“ã€‚

ğŸ”¹**æ›´å¤šæœ¯è¯­å°å¡**

**Q:** è¿”å›ç /é€€å‡ºç  (return/exit code) å­˜åœ¨å“ªé‡Œï¼Ÿ

**A:** å­˜åœ¨å­è¿›ç¨‹çš„ PCB/TCB ä¸­ï¼Œçˆ¶è¿›ç¨‹é€šè¿‡ wait()/pthread_join() å–èµ°ã€‚

  

**Q:** errno æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** çº¿ç¨‹å±€éƒ¨çš„é”™è¯¯ç å˜é‡ï¼Œç³»ç»Ÿè°ƒç”¨å¤±è´¥æ—¶è®¾ç½®ï¼›perror() æ®æ­¤æ‰“å°å¯è¯»ä¿¡æ¯ã€‚

  

**Q:** å¥æŸ„èƒ½å¦â€œè·¨ execâ€ä¿ç•™ï¼Ÿ

**A:** é»˜è®¤**ä¿ç•™**å·²æ‰“å¼€ fdï¼›é™¤éè®¾ç½® FD_CLOEXECï¼ˆfcntlï¼‰ï¼Œä½¿å…¶åœ¨ exec æ—¶è‡ªåŠ¨å…³é—­ã€‚

  

**Q:** dup2(oldfd, newfd) æœ‰å•¥ç”¨ï¼Ÿ

**A:** æŠŠ newfd æŒ‡å‘ oldfd çš„åŒä¸€å¯¹è±¡ï¼ˆå¿…è¦æ—¶å…ˆå…³é—­ newfdï¼‰ï¼Œæ˜¯**é‡å®šå‘**çš„å¸¸ç”¨åŸè¯­ã€‚

  

**Q:** wait() æ˜¯é˜»å¡è°ƒç”¨å—ï¼Ÿ

**A:** æ˜¯ã€‚æ²¡æœ‰å·²ç»“æŸçš„å­è¿›ç¨‹æ—¶ä¼šç¡çœ ï¼Œç›´åˆ°æŸä¸ªå­è¿›ç¨‹ç»“æŸã€‚

  

**Q:** çº¿ç¨‹ä¹‹é—´æœ‰çˆ¶å­å…³ç³»å—ï¼Ÿ

**A:** **æ²¡æœ‰**ã€‚ä»»ä½•çº¿ç¨‹åªè¦æ‹¿åˆ° pthread_t éƒ½èƒ½ join å¦ä¸€ä¸ªçº¿ç¨‹ï¼›ä½†**åŒä¸€çº¿ç¨‹ä¸èƒ½è¢« join ä¸¤æ¬¡**ã€‚

  

**Q:** åƒµå°¸çº¿ç¨‹ä¸åƒµå°¸è¿›ç¨‹çš„ç›¸ä¼¼ç‚¹ï¼Ÿ

**A:** éƒ½æ˜¯**å·²ç»“æŸä½†æœªè¢«æ”¶å‰²**çš„æ‰§è¡Œå®ä½“ï¼›ä¿ç•™ ID/è¿”å›å€¼ç­‰ï¼Œç›´åˆ°è¢« join/wait æ¸…ç†ã€‚

--- 

ğŸ”¹**Mutex åˆå§‹åŒ–**

**Q:** å¦‚ä½•é™æ€åˆå§‹åŒ–ä¸€ä¸ª pthread äº’æ–¥é”ï¼Ÿ

**A:**
```
pthread_mutex_t m = PTHREAD_MUTEX_INITIALIZER;
```
è¿™æ˜¯æœ€å¸¸è§çš„å†™æ³•ï¼Œç¼–è¯‘æ—¶å°±å®Œæˆäº†åˆå§‹åŒ–ã€‚åˆå§‹çŠ¶æ€ï¼š**è§£é” (unlocked)**ã€‚

ğŸ”¹**åŠ¨æ€åˆå§‹åŒ–**

**Q:** å¦‚æœä¸€ä¸ª mutex ä¸èƒ½ç”¨ PTHREAD_MUTEX_INITIALIZER é™æ€åˆå§‹åŒ–ï¼Œæ€ä¹ˆåŠï¼Ÿ

**A:** ä½¿ç”¨ pthread_mutex_init()ï¼š
```
pthread_mutex_t m;
pthread_mutex_init(&m, NULL);
```
ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ä¼  pthread_mutexattr_t å±æ€§ï¼ˆä¸€èˆ¬ä¼  NULLï¼Œè¡¨ç¤ºé»˜è®¤å±æ€§ï¼‰ã€‚


ğŸ”¹**é”€æ¯ mutex**

**Q:** ä¸ºä»€ä¹ˆè¦è°ƒç”¨ pthread_mutex_destroy()ï¼Ÿ

**A:** ç”¨å®Œäº’æ–¥é”åè¦é‡Šæ”¾å…¶å†…éƒ¨èµ„æºï¼š
```
pthread_mutex_destroy(&m);
```
ğŸ”¹**é¢å¤–è¯´æ˜**

**Q:** pthread_mutexattr_t æœ‰ä»€ä¹ˆç”¨ï¼Ÿ

**A:** å®ƒå…è®¸é…ç½®ä¸€äº›ç‰¹æ®Šå±æ€§ï¼Œæ¯”å¦‚**é€’å½’é”**ï¼ˆåŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡åŠ é”ï¼‰ã€**é”™è¯¯æ£€æµ‹**æ¨¡å¼ç­‰ã€‚å¤§å¤šæ•°æƒ…å†µç”¨ä¸åˆ°ï¼Œæ‰€ä»¥ slides è¯´ _â€œUsually, mutex attributes are not usedâ€_ã€‚

ğŸ”¹**é™æ€åˆå§‹åŒ–**

**Q:** é™æ€åˆå§‹åŒ– pthread_mutex_t m = PTHREAD_MUTEX_INITIALIZER; æœ‰ä»€ä¹ˆé™åˆ¶ï¼Ÿ

**A:**

- åªèƒ½ç”¨äº **é™æ€å­˜å‚¨æœŸå˜é‡**ï¼ˆå¦‚å…¨å±€å˜é‡ã€static å±€éƒ¨å˜é‡ï¼‰ã€‚
    
- ç¼–è¯‘æ—¶åˆå§‹åŒ–ï¼Œç¨‹åºå¯åŠ¨æ—¶å°±å·²ç»åˆ†é…å¹¶åˆå§‹åŒ–å¥½äº†ã€‚
    
- ä¸é€‚åˆåœ¨**è¿è¡Œæ—¶åŠ¨æ€åˆ†é…çš„åœºæ™¯**ã€‚


ğŸ”¹**åŠ¨æ€åˆå§‹åŒ–**

**Q:** ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€åˆå§‹åŒ– pthread_mutex_init()ï¼Ÿ

**A:**

1. **åœ¨å †ä¸Šåˆ†é…çš„ mutex**
    
    - æ¯”å¦‚é€šè¿‡ malloc åŠ¨æ€åˆ›å»ºçš„ç»“æ„ä½“é‡Œå«æœ‰ pthread_mutex_tï¼Œå°±å¿…é¡»è¿è¡Œæ—¶è°ƒç”¨ pthread_mutex_init()ã€‚
```
typedef struct {
    int data;
    pthread_mutex_t lock;
} shared_t;

shared_t *p = malloc(sizeof(shared_t));
pthread_mutex_init(&p->lock, NULL);
```
2. **éœ€è¦è‡ªå®šä¹‰å±æ€§**
    
    - æ¯”å¦‚è¦åˆ›å»ºé€’å½’é”ï¼š
```
pthread_mutexattr_t attr;
pthread_mutexattr_init(&attr);
pthread_mutexattr_settype(&attr, PTHREAD_MUTEX_RECURSIVE);

pthread_mutex_t m;
pthread_mutex_init(&m, &attr);
pthread_mutexattr_destroy(&attr);
```
3. **è¿è¡Œæ—¶æ§åˆ¶èµ„æºç”Ÿå‘½å‘¨æœŸ**
    
    - ä½ å¯èƒ½éœ€è¦åœ¨æŸä¸ªæ—¶åˆ»åˆ›å»ºå’Œé”€æ¯é”ï¼ˆä¾‹å¦‚çº¿ç¨‹æ± æˆ–æœåŠ¡å™¨ä¸­ï¼Œè¿æ¥å¯¹è±¡çš„åˆ›å»º/é”€æ¯è¿‡ç¨‹ï¼‰ã€‚


ğŸ”¹**é”€æ¯çš„å¿…è¦æ€§**

**Q:** ä¸ºä»€ä¹ˆè¿˜è¦ pthread_mutex_destroy()ï¼Ÿ

**A:**

- é¿å…å†…æ ¸/åº“èµ„æºæ³„æ¼ã€‚
    
- é™æ€åˆå§‹åŒ–çš„å…¨å±€ mutex åœ¨ç¨‹åºç»“æŸæ—¶ä¼šç”±æ“ä½œç³»ç»Ÿå›æ”¶ï¼Œä½†**åŠ¨æ€åˆ›å»ºçš„å¯¹è±¡**å¿…é¡»æ‰‹åŠ¨é”€æ¯ã€‚



ğŸ”¹**äº’æ–¥ä¸åŸå­æ€§ (Mutual Exclusion & Atomicity)**

**Q:** ä¸ºä»€ä¹ˆ x = x+1 ä¸æ˜¯åŸå­æ“ä½œï¼Ÿ

**A:** å› ä¸ºæœºå™¨å®é™…æ‰§è¡Œä¸ºï¼š
```
ld   r1, x    // load
add  r1, 1    // add
st   r1, x    // store
```
è‹¥çº¿ç¨‹åœ¨æ‰§è¡Œä¸­é€”è¢«åˆ‡æ¢ï¼Œå¯èƒ½å’Œå¦ä¸€ä¸ªçº¿ç¨‹äº¤é”™æ‰§è¡Œï¼Œæœ€ç»ˆç»“æœé”™è¯¯ï¼ˆåªåŠ  1 è€Œä¸æ˜¯ 2ï¼‰ã€‚

  

**Q:** ä»€ä¹ˆæ˜¯â€œåŸå­æ€§ (atomicity)â€ï¼Ÿ

**A:** ä¸€æ®µæ“ä½œè¦ä¹ˆ**å…¨éƒ¨å®Œæˆ**ï¼Œè¦ä¹ˆ**å®Œå…¨ä¸æ‰§è¡Œ**ï¼Œä¸­é—´ä¸èƒ½è¢«æ‰“æ–­ã€‚å¯¹ x=x+1 æ¥è¯´ï¼Œä¸‰ä¸ªæŒ‡ä»¤å¿…é¡»ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œã€‚

  

**Q:** åŸå­æ€§æ˜¯å¦æ„å‘³ç€ CPU ä¸ä¼šå»å¹²åˆ«çš„äº‹ï¼Ÿ

**A:** ä¸æ˜¯ã€‚CPU å¯ä»¥åˆ‡æ¢å»å¹²åˆ«çš„ï¼Œä½†åªè¦è¿™äº›æ“ä½œ**ä¸æ¶‰åŠåŒä¸€ä¸ªå˜é‡ x**ï¼Œå°±ä¸å½±å“åŸå­æ€§ã€‚

---
ğŸ”¹**Critical Section ä¸ Mutex**

**Q:** ä»€ä¹ˆæ˜¯ä¸´ç•ŒåŒº (critical section)ï¼Ÿ

**A:** åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œè®¿é—®å…±äº«å˜é‡çš„ä»£ç ç‰‡æ®µã€‚å¿…é¡»é€šè¿‡äº’æ–¥é”ä¿æŠ¤ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚

  

**Q:** ä¸ºä»€ä¹ˆ slide é‡Œç”¨â€œå®‰å…¨å­˜å‚¨ç®± (safe-deposit box)â€æ¥æ¯”å–» mutexï¼Ÿ

**A:** å…±äº«å˜é‡åƒå­˜æ”¾åœ¨ä¿é™©ç®±é‡Œçš„ä¸œè¥¿ï¼Œmutex å°±åƒé’¥åŒ™ã€‚çº¿ç¨‹å¿…é¡»å…ˆæ‹¿åˆ°é’¥åŒ™æ‰èƒ½è¿›å…¥ä¸´ç•ŒåŒºï¼Œåˆ«äººåªèƒ½ç­‰å¾…ã€‚

---

ğŸ”¹**åºåˆ—åŒ–ç›’å­ (Serialization Box)**

**Q:** slide ä¸ºä»€ä¹ˆæåˆ° â€œSerialization Boxâ€ï¼Ÿ

**A:** æŠ½è±¡æ¨¡å‹ï¼šmutex æŠŠæ‰€æœ‰è®¿é—®å…±äº«å˜é‡çš„ä»£ç â€œæ”¾è¿›åŒä¸€ä¸ªç›’å­é‡Œâ€ï¼Œä¸€æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼Œè¿™æ ·è®¿é—®å°±è¢«**åºåˆ—åŒ–**äº†ã€‚

---

ğŸ”¹**å¤šä¸ªä¸´ç•ŒåŒº**

**Q:** ä¸€ä¸ª mutex å¯ä»¥ä¿æŠ¤å¤šä¸ªä¸åŒçš„ä¸´ç•ŒåŒºå—ï¼Ÿ

**A:** å¯ä»¥ã€‚åªè¦ç”¨ç›¸åŒçš„ mutex ä¸Šé”è§£é”ï¼Œå®ƒä»¬å°±æ˜¯åŒä¸€ä¸ªâ€œåºåˆ—åŒ–ç›’å­â€ï¼Œä¿è¯äº’æ–¥ã€‚

---

ğŸ”¹**å¤šæŠŠé”ä¸æ­»é” (Deadlock)**

**Q:** ä¸ºä»€ä¹ˆå¤šæŠŠé”å®¹æ˜“å‡ºé—®é¢˜ï¼Ÿ

**A:** å¦‚æœçº¿ç¨‹ 1 å…ˆæ‹¿é” m1 å†ç­‰ m2ï¼Œè€Œçº¿ç¨‹ 2 å…ˆæ‹¿ m2 å†ç­‰ m1ï¼Œå°±å¯èƒ½å½¢æˆ**å¾ªç¯ç­‰å¾…** â†’ æ­»é”ã€‚

  

**Q:** å¦‚ä½•è¡¨ç¤ºæ­»é”ï¼Ÿ

**A:** ç”¨â€œç­‰å¾…å›¾ (wait-for graph)â€ï¼š

- èŠ‚ç‚¹ = çº¿ç¨‹æŒæœ‰/ç­‰å¾…çš„é”ã€‚
    
- è¾¹ = ä»å·²æŒæœ‰çš„é”æŒ‡å‘æ­£åœ¨ç­‰å¾…çš„é”ã€‚
    
- å‡ºç°**ç¯**å°±è¡¨ç¤ºæ­»é”ã€‚

---
ğŸ”¹**æ­»é” (Deadlock)**

**Q:** å¤šä¸ªçº¿ç¨‹å¦‚ä½•äº§ç”Ÿæ­»é”ï¼Ÿ

**A:** å¦‚æœçº¿ç¨‹ 1 æ‹¿äº†é” m1 ç­‰ m2ï¼Œçº¿ç¨‹ 2 æ‹¿äº†é” m2 ç­‰ m1ï¼Œå°±äº’ç›¸ç­‰å¾… â†’ æ­»é”ã€‚å¯ç”¨â€œç­‰å¾…å›¾ (wait-for graph)â€è¡¨ç¤ºï¼šä»æŒæœ‰çš„é”ç”»ç®­å¤´æŒ‡å‘ç­‰å¾…çš„é”ï¼Œè‹¥å‡ºç°ç¯è·¯å³å¯èƒ½æ­»é”ã€‚

  

**Q:** æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ

**A:**

1. æœ‰ç•Œèµ„æºï¼ˆæœ‰é™çš„èµ„æºæ•°é‡ï¼‰
    
2. è¯·æ±‚å¹¶ä¿æŒï¼ˆæŒæœ‰éƒ¨åˆ†èµ„æºè¿˜è¦ç­‰æ–°çš„èµ„æºï¼‰
    
3. ä¸å¯æŠ¢å ï¼ˆä¸èƒ½å¼ºåˆ¶å‰¥å¤ºèµ„æºï¼‰
    
4. å¾ªç¯ç­‰å¾…ï¼ˆå½¢æˆä¸€ä¸ªç¯çŠ¶ç­‰å¾…é“¾ï¼‰
    
    â†’ å››è€…åŒæ—¶æˆç«‹æ‰å¯èƒ½æ­»é”ã€‚
    

  

**Q:** å¤„ç†æ­»é”æœ‰å“ªä¸¤ç§æ€è·¯ï¼Ÿ

**A:**

- **æ£€æµ‹ (detection)**ï¼šåˆ¤æ–­ç³»ç»Ÿæ˜¯å¦æ­»é”ï¼Œéš¾åº¦å¤§ï¼Œæ£€æµ‹åå¤„ç†å¤æ‚ã€‚
    
- **é¢„é˜² (prevention)**ï¼šç”¨è§„åˆ™è®©æ­»é”æ ¹æœ¬ä¸å¯èƒ½å‘ç”Ÿï¼ˆå¦‚é™åˆ¶åŠ é”é¡ºåºï¼‰ï¼Œç›¸å¯¹ç®€å•ã€‚è¯¾ç¨‹æ¨èæŠŠæ­»é”å½“ä½œç¼–ç¨‹ bugï¼Œä¼˜å…ˆé¢„é˜²ã€‚
    

---

ğŸ”¹**åŠ é”å±‚çº§ (Lock Hierarchies)**

**Q:** ä»€ä¹ˆæ˜¯é”çš„å±‚çº§ (Lock Hierarchy)ï¼Ÿ

**A:** ç»™æ¯ä¸ªé”åˆ†é…ç­‰çº§ã€‚è‹¥å·²æŒæœ‰ç­‰çº§ â‰¥ i çš„é”ï¼Œå°±ä¸èƒ½å†ç”³è¯·ç­‰çº§ â‰¤ i çš„é”ï¼Œåªèƒ½ç”³è¯·æ›´é«˜ç­‰çº§çš„é”ã€‚è¿™æ ·é¿å…å¾ªç¯ç­‰å¾…ã€‚

  

**Q:** é”å±‚çº§çš„å®é™…è§„åˆ™ä¾‹å­ï¼Ÿ

**A:** è‹¥çº¿ç¨‹å·²æŒæœ‰ level 2 å’Œ 3 çš„é”ï¼Œå°±åªèƒ½å†ç”³è¯· level 4+ çš„é”ï¼Œä¸å…è®¸ç”³è¯·æ›´ä½ç­‰çº§ã€‚

---

ğŸ”¹**æ¡ä»¶åŠ é” (Conditional Locking)**

**Q:** å¦‚æœé”æ— æ³•åˆ†å±‚ï¼Œå¦‚ä½•é¿å…æ­»é”ï¼Ÿ

**A:** ç”¨æ¡ä»¶åŠ é”ï¼šå¦‚æœå°è¯•ç¬¬äºŒæŠŠé”å¤±è´¥ï¼Œå°±é‡Šæ”¾ç¬¬ä¸€æŠŠé”é‡è¯•ï¼Œé¿å…â€œè¯·æ±‚å¹¶ä¿æŒâ€ã€‚
```
while (1) {
  pthread_mutex_lock(&m2);
  if (!pthread_mutex_trylock(&m1)) break;
  pthread_mutex_unlock(&m2);
}
/* åŒæ—¶æŒæœ‰ m1,m2 */
pthread_mutex_unlock(&m1);
pthread_mutex_unlock(&m2);
```
---
ğŸ”¹**Mutex å°ç»“**

**Q:** ä»€ä¹ˆæ—¶å€™å…±äº«æ•°æ®ä¸éœ€è¦é”ï¼Ÿ

**A:** å½“å¤šä¸ªçº¿ç¨‹åªæ˜¯**åªè¯»**å…±äº«æ•°æ®æ—¶ã€‚

  

**Q:** å¦‚æœå¤šä¸ªçº¿ç¨‹è¯»å†™å…±äº«æ•°æ®æ€ä¹ˆåŠï¼Ÿ

**A:** å¿…é¡»åŠ é”ï¼Œä½¿ç”¨ä¸´ç•ŒåŒºè®¿é—®ã€‚å¯ä»¥ä¸€æŠŠé”ä¿æŠ¤ï¼Œä¹Ÿå¯èƒ½ä½¿ç”¨å¤šæŠŠé”ä¸ä¸åŒçº¿ç¨‹äº¤äº’ã€‚

---

ğŸ”¹**è¶…è¶Š Mutex (Beyond Mutexes)**

**Q:** ä»€ä¹ˆæ—¶å€™ mutex è¿‡äºä¿å®ˆï¼Ÿ

**A:**

1. å¤šæ•°æ—¶å€™çº¿ç¨‹äº’ä¸å¹²æ‰°ï¼Œä»…å¶å°”éœ€è¦åŒæ­¥ã€‚
    
2. æœ‰çš„çº¿ç¨‹åªéœ€è¦è¯»æ•°æ®ï¼Œä¸å¿…å’Œå†™è€…å®Œå…¨äº’æ–¥ã€‚
    
    ä¾‹å­ï¼š**ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜**ã€**è¯»è€…-å†™è€…é—®é¢˜**ã€**æ …æ åŒæ­¥ (Barrier)**ã€‚
    

---

ğŸ”¹**ç”Ÿäº§è€…-æ¶ˆè´¹è€… (Producer-Consumer)**

**Q:** ä¸ºä»€ä¹ˆç”¨ä¸€æŠŠå¤§é”è§£å†³ç”Ÿäº§è€…-æ¶ˆè´¹è€…å¤ªä¿å®ˆï¼Ÿ

**A:** å› ä¸ºå¤§éƒ¨åˆ†æ—¶é—´ç”Ÿäº§å’Œæ¶ˆè´¹å¯ä»¥å¹¶è¡Œï¼Œåªæœ‰åœ¨ç¼“å†²åŒº**æ»¡**æˆ–**ç©º**æ—¶æ‰éœ€è¦é˜»å¡ã€‚ç”¨å¤§é”ä¼šè®©ä¸å†²çªçš„æ“ä½œä¹Ÿè¢«é”ä½ï¼Œé™ä½æ•ˆç‡ã€‚

  

**Q:** è½¯ä»¶é‡Œå¦‚ä½•å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼Ÿ

**A:** ç”¨**ç¯å½¢ç¼“å†²åŒº (circular buffer)**ï¼Œå¹¶é…åˆæ›´åˆé€‚çš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚ä¿¡å·é‡ï¼‰æ¥åœ¨æ»¡/ç©ºæ—¶é˜»å¡ã€‚

---

ğŸ”¹**å®ˆæŠ¤å‘½ä»¤ (Guarded Commands)**

**Q:** ä»€ä¹ˆæ˜¯ Guarded Commandï¼Ÿ

**A:** ä¸€ç§ä¼ªä»£ç ç»“æ„ï¼š
```
when (guard) [
   // ä¸€æ—¦ guard ä¸ºçœŸï¼ŒåŸå­åœ°æ‰§è¡Œä»£ç 
]
```
**è¯­ä¹‰**ï¼šå½“ guard ä¸ºçœŸæ—¶ï¼Œ**åŸå­åœ°**è¯„ä¼° guard å¹¶æ‰§è¡Œå‘½ä»¤åºåˆ—ã€‚åŸå­æ€§è¡¨ç¤ºâ€œåƒç¬é—´å®Œæˆä¸€æ ·â€ã€‚

  

**Q:** Guarded Command æ˜¯å¦ç­‰äºä¸´ç•ŒåŒºï¼Ÿ

**A:** ä¸åŒã€‚ä¸´ç•ŒåŒºæ˜¯é€šè¿‡é”ä¿æŠ¤çš„ä¸€æ®µä»£ç ï¼›Guarded Command æ˜¯æŠ½è±¡è¯­ä¹‰ï¼Œè¡¨ç¤º guard æ£€æŸ¥+ä»£ç æ‰§è¡Œä¸å¯åˆ†å‰²ã€‚

---

ğŸ”¹**ä¿¡å·é‡ (Semaphores)**

**Q:** ä¿¡å·é‡çš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** ä¸€ä¸ªéè´Ÿæ•´æ•° Sï¼Œåªèƒ½é€šè¿‡ä¸¤ç§æ“ä½œä¿®æ”¹ï¼š

- P(S)ï¼šå½“ S>0 æ—¶æ‰§è¡Œ S--ï¼Œå¦åˆ™é˜»å¡ã€‚
    
- V(S)ï¼šæ‰§è¡Œ S++ã€‚
    
    åˆå§‹åŒ–åä¸èƒ½ç›´æ¥ä¿®æ”¹ã€‚
    

  

**Q:** å¦‚ä½•ç”¨äºŒå€¼ä¿¡å·é‡å®ç°äº’æ–¥ï¼Ÿ

**A:** åˆå§‹åŒ– S=1ï¼Œè¿›å…¥ä¸´ç•ŒåŒºå‰ P(S)ï¼Œé€€å‡ºæ—¶ V(S)ã€‚åŠŸèƒ½ç±»ä¼¼ mutexã€‚
```
semaphore S = 1;
P(S);
x = x+1;
V(S);
```
**Q:** è®¡æ•°ä¿¡å·é‡ (Counting Semaphore) çš„ç”¨é€”ï¼Ÿ

**A:** S=Nï¼Œè¡¨ç¤ºåŒä¸€æ—¶é—´å…è®¸æœ€å¤š N ä¸ªçº¿ç¨‹è¿›å…¥ã€‚ç”¨äºï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆè®°å½•ç©ºæ§½/æ»¡æ§½æ•°ï¼‰ã€è¿æ¥æ± ã€é™æµç­‰ã€‚

  

**Q:** ä¿¡å·é‡å’Œäº’æ–¥é”çš„å…³é”®åŒºåˆ«ï¼Ÿ

**A:** mutex è¦æ±‚**åŒä¸€çº¿ç¨‹ lock/unlock æˆå¯¹**ï¼›semaphore çš„ P å’Œ V å¯ä»¥ç”±**ä¸åŒçº¿ç¨‹**æ‰§è¡Œï¼ˆç”Ÿäº§è€… Vï¼Œæ¶ˆè´¹è€… Pï¼‰ï¼Œæ”¯æŒè·¨çº¿ç¨‹â€œé…é¢äº¤æ¥â€ã€‚


---
ğŸ”¹**Producer-Consumer with Semaphores**

**Q:** å¦‚ä½•ç”¨ä¿¡å·é‡å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼Ÿ

**A:** ä½¿ç”¨ä¸¤ä¸ªä¿¡å·é‡ï¼š

- empty = Bï¼ˆç©ºæ§½æ•°ï¼Œåˆå§‹ä¸ºç¼“å†²åŒºå¤§å° Bï¼‰
    
- occupied = 0ï¼ˆå·²å ç”¨æ§½æ•°ï¼Œåˆå§‹ 0ï¼‰
    

  

ä»£ç éª¨æ¶ï¼š
```
void Produce(char item) {
  P(empty);                // ç­‰å¾…è‡³å°‘ä¸€ä¸ªç©ºæ§½
  buf[nextin] = item;
  nextin = (nextin+1) % B; // ç¯å½¢ç¼“å†²
  V(occupied);             // å¢åŠ å·²å ç”¨
}

char Consume() {
  P(occupied);             // ç­‰å¾…è‡³å°‘ä¸€ä¸ªæ»¡æ§½
  char item = buf[nextout];
  nextout = (nextout+1) % B;
  V(empty);                // å¢åŠ ç©ºæ§½
  return item;
}
```
---

ğŸ”¹**ä¿¡å·é‡åœ¨è¿è¡Œæ—¶çš„è¡Œä¸º**

**Q:** å¦‚æœç”Ÿäº§å’Œæ¶ˆè´¹é€Ÿåº¦ç›¸åŒï¼Œä¼šæ€æ ·ï¼Ÿ

**A:** åŒæ–¹å¯èƒ½ä¸éœ€è¦ç­‰å¾…ï¼Œç”Ÿäº§è€…åˆšæ”¾è¿›å»æ¶ˆè´¹è€…å°±å–èµ°ï¼Œå½¢æˆâ€œæµæ°´çº¿å¹¶è¡Œâ€ã€‚

  

**Q:** å¦‚æœç”Ÿäº§è€…å¿«ï¼Œæ¶ˆè´¹è€…æ…¢ï¼Œä¼šæ€æ ·ï¼Ÿ

**A:** å½“ç¼“å†²åŒºæ»¡äº†ï¼Œempty=0ï¼Œç”Ÿäº§è€…é˜»å¡ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚

  

**Q:** å¦‚æœæ¶ˆè´¹è€…å¿«ï¼Œç”Ÿäº§è€…æ…¢ï¼Œä¼šæ€æ ·ï¼Ÿ

**A:** å½“ç¼“å†²åŒºç©ºäº†ï¼Œoccupied=0ï¼Œæ¶ˆè´¹è€…é˜»å¡ç­‰å¾…ç”Ÿäº§è€…ç”Ÿäº§ã€‚

---

ğŸ”¹**Mutex vs Semaphore**

**Q:** ä¸ºä»€ä¹ˆåªç”¨ mutex ä¸å¤Ÿï¼Ÿ

**A:** ä¸€æŠŠå¤§é”åªèƒ½ä¿è¯äº’æ–¥ï¼Œè¿‡äºç²—ç²’åº¦ï¼Œæ‰€æœ‰æ“ä½œè¢«ä¸²è¡ŒåŒ–ã€‚

ä¿¡å·é‡å¯ä»¥å®ç°**æ¡ä»¶åŒæ­¥**ï¼šåªæœ‰åœ¨ç¼“å†²åŒºæ»¡/ç©ºæ—¶æ‰é˜»å¡ â†’ å¹¶è¡Œåº¦æ›´é«˜ã€‚

  

**Q:** ä¿¡å·é‡æœ€å…¸å‹çš„ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ

**A:** **ç”Ÿäº§è€…-æ¶ˆè´¹è€…é—®é¢˜ï¼ˆä¹Ÿå«æœ‰ç•Œç¼“å†²åŒºé—®é¢˜ï¼‰**ã€‚è¿™å‡ ä¹æ˜¯ä¿¡å·é‡çš„â€œä»£è¡¨æ€§åº”ç”¨â€ã€‚

---

ğŸ”¹**POSIX Semaphores**

**Q:** POSIX æä¾›äº†å“ªäº›ä¿¡å·é‡ APIï¼Ÿ

**A:**
```
sem_t sem;
sem_init(&sem, pshared, init_value);
sem_destroy(&sem);
sem_wait(&sem);     // P æ“ä½œ
sem_trywait(&sem);  // æ¡ä»¶ P æ“ä½œ
sem_post(&sem);     // V æ“ä½œ
```
å…¶ä¸­ pshared=0 è¡¨ç¤ºåªåœ¨åŒä¸€è¿›ç¨‹å†…å…±äº«ã€‚

---

ğŸ”¹**å®ç°ä¿¡å·é‡çš„åŸç†**

**Q:** å¦‚ä½•ç”¨ mutex å®ç°ä¸€ä¸ª P(S) æ“ä½œï¼Ÿ

**A:** ä¼ªä»£ç ï¼š
```
while (1) {
  pthread_mutex_lock(&m);
  if (S > 0) {
    S = S - 1;
    pthread_mutex_unlock(&m);
    break;
  }
  pthread_mutex_unlock(&m);
  // é‡è¯•
}
```
è¿™ä¼šå¯¼è‡´ **busy waiting**ï¼ŒCPU ç©ºè½¬ï¼Œä¸é«˜æ•ˆã€‚

  

**Q:** ä¸ºä»€ä¹ˆ busy waiting ä¸å¥½ï¼Ÿ

**A:** çº¿ç¨‹åœ¨ç­‰å¾…æ¡ä»¶æ—¶ä¸åšæœ‰ç”¨å·¥ä½œï¼Œè€Œä¸”æŒç»­å ç”¨ CPUã€‚

---

ğŸ”¹**Guarded Commands çš„ä¸€èˆ¬å®ç°**

**Q:** å¦‚æœ guard å¾ˆå¤æ‚æ€ä¹ˆåŠï¼Ÿ

**A:** å¿…é¡»â€œé‡‡æ ·â€æ‰€æœ‰ç›¸å…³å˜é‡ï¼Œå¹¶ä¸”ç”¨ mutex ä¿è¯åœ¨æ£€æŸ¥å’Œæ‰§è¡Œä¹‹é—´ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚

  

**Q:** Busy waiting å¦‚ä½•æ”¹è¿›ï¼Ÿ

**A:** å¼•å…¥ **æ¡ä»¶å˜é‡ (Condition Variable, CV)**ï¼Œè®©ç­‰å¾…çš„çº¿ç¨‹è¿›å…¥ç¡çœ é˜Ÿåˆ—ï¼Œä¸å ç”¨ CPUã€‚

---

ğŸ”¹**Condition Variables**

**Q:** ä»€ä¹ˆæ˜¯æ¡ä»¶å˜é‡ (CV)ï¼Ÿ

**A:** ä¸€ç§åŒæ­¥åŸè¯­ï¼Œä¿å­˜ç­‰å¾…æŸä¸ªæ¡ä»¶çš„çº¿ç¨‹é˜Ÿåˆ—ã€‚

çº¿ç¨‹åœ¨ pthread_cond_wait() é‡Œç¡çœ ï¼Œç›´åˆ°è¢«å…¶ä»–çº¿ç¨‹ signal æˆ– broadcast å”¤é†’ã€‚

  

**Q:** pthread_cond_wait() åšäº†ä»€ä¹ˆï¼Ÿ

**A:**

1. å¿…é¡»åœ¨æŒæœ‰ mutex æ—¶è°ƒç”¨ã€‚
    
2. åŸå­åœ°ï¼šé‡Šæ”¾ mutex â†’ é˜»å¡ç­‰å¾…äº‹ä»¶ã€‚
    
3. è¢«å”¤é†’æ—¶ï¼šé‡æ–°è·å– mutexï¼Œè¿”å›ã€‚
    

  

**Q:** pthread_cond_signal() vs pthread_cond_broadcast()ï¼Ÿ

**A:**

- signal() å”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚
    
- broadcast() å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ã€‚
    

---

ğŸ”¹**Guarded Commands with CV (POSIX å®ç°)**

**Q:** å¦‚ä½•ç”¨æ¡ä»¶å˜é‡å®ç° guarded commandï¼Ÿ

**A:**
```
pthread_mutex_lock(&mutex);
while (!guard)
    pthread_cond_wait(&cv, &mutex);
... // guard ä¸ºçœŸæ—¶æ‰§è¡Œä»£ç 
pthread_mutex_unlock(&mutex);
```
ä¿®æ”¹ guard çš„åœ°æ–¹ï¼š
```
pthread_mutex_lock(&mutex);
... // ä¿®æ”¹ guard çš„ä»£ç 
pthread_cond_broadcast(&cv); // å”¤é†’ç­‰å¾… guard çš„çº¿ç¨‹
pthread_mutex_unlock(&mutex);
```
**è§„åˆ™**ï¼š

- æ‰€æœ‰ pthread_cond_wait/signal/broadcast è°ƒç”¨å¿…é¡»åœ¨ mutex ä¿æŠ¤ä¸‹è¿›è¡Œã€‚
    
- å¦‚æœä¸æŒ‰è§„åˆ™æ¥ï¼Œå¯èƒ½å‡ºç° race conditionï¼ˆçº¿ç¨‹é”™è¿‡ä¿¡å·æ°¸è¿œç¡çœ ï¼‰ã€‚
    

---

âœ… **æ€»ç»“**

- ä¿¡å·é‡é€‚åˆå®ç° **ç”Ÿäº§è€…-æ¶ˆè´¹è€…**ï¼Œèƒ½ä¿è¯ buffer æ»¡/ç©ºæ—¶æ­£ç¡®é˜»å¡ã€‚
    
- ä½†ä¿¡å·é‡ç”¨é€”æœ‰é™ï¼Œä¸é€‚åˆæ›´å¤æ‚çš„æ¡ä»¶ã€‚
    
- æ›´é€šç”¨çš„æ–¹æ³•æ˜¯ **æ¡ä»¶å˜é‡ (CV)**ï¼Œé…åˆ mutexï¼Œå®ç°ä»»æ„å¤æ‚ guard çš„ guarded commandã€‚

----
## **ğŸ”¹POSIX Condition Variables**

  

Q: POSIX æ¡ä»¶å˜é‡æ˜¯æ€ä¹ˆå®ç° Guarded Command çš„ï¼Ÿ

A: ä½¿ç”¨ pthread_mutex_lock å’Œ pthread_cond_wait å®ç°ï¼š
```
pthread_mutex_lock(&mutex);
while (!guard)
    pthread_cond_wait(&cv, &mutex);
/* critical section */
pthread_mutex_unlock(&mutex);
```
ä¿®æ”¹ guard æ—¶ï¼Œéœ€è¦ pthread_cond_signal() æˆ– pthread_cond_broadcast() å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚

  

Q: ä¸ºä»€ä¹ˆå¿…é¡»åœ¨æŒæœ‰é”æ—¶è°ƒç”¨ pthread_cond_wait() å’Œ pthread_cond_signal()ï¼Ÿ

A: é¿å… race conditionã€‚å¦‚æœä¸åŠ é”ï¼Œå¯èƒ½ guard åˆšè¢«ä¿®æ”¹ä½†çº¿ç¨‹è¿˜æ²¡ç­‰åˆ°ä¿¡å·å°±é”™è¿‡äº†ã€‚

---

## **ğŸ”¹Readersâ€“Writers Problem (è¯»è€…â€“å†™è€…é—®é¢˜)**

  

Q: è¯»è€…å†™è€…é—®é¢˜çš„æ ¸å¿ƒçŸ›ç›¾æ˜¯ä»€ä¹ˆï¼Ÿ

A: å¤šä¸ªè¯»è€…å¯ä»¥å¹¶å‘è¯»å–ï¼Œä½†å†™è€…å¿…é¡»ç‹¬å ï¼Œä¸”ä¸èƒ½ä¸è¯»è€…åŒæ—¶è¿›è¡Œã€‚

  

Q: åŸºæœ¬ä¼ªä»£ç å¦‚ä½•å®ç°ï¼Ÿ

A:
```
reader() {
  when (writers == 0) [ readers++; ]
  /* read */
  [ readers--; ]
}

writer() {
  when ((writers == 0) && (readers == 0)) [ writers++; ]
  /* write */
  [ writers--; ]
}
```
Q: ä¸ºä»€ä¹ˆ readers åƒè®¡æ•°ä¿¡å·é‡ (counting semaphore)ï¼Œwriters åƒäºŒè¿›åˆ¶ä¿¡å·é‡ (binary semaphore)ï¼Ÿ

A:

- readersï¼šå¯ä»¥å¤šä¸ª reader åŒæ—¶å¢åŠ ï¼Œè®¡æ•°ç±»ä¼¼ counting semaphoreã€‚
    
- writersï¼šè¦ä¹ˆæœ‰ 0ï¼Œè¦ä¹ˆæœ‰ 1 ä¸ª writerï¼Œå ç”¨ç±»ä¼¼ binary semaphoreã€‚
    

---

## **ğŸ”¹POSIX å®ç° Reader ä»£ç 

  

Q: POSIX ç‰ˆçš„ reader() æ˜¯æ€ä¹ˆå†™çš„ï¼Ÿ

A:
```
reader() {
  pthread_mutex_lock(&m);
  while (!(writers == 0))
    pthread_cond_wait(&readersQ, &m);
  readers++;
  pthread_mutex_unlock(&m);

  /* read */

  pthread_mutex_lock(&m);
  if (--readers == 0)
    pthread_cond_signal(&writersQ);
  pthread_mutex_unlock(&m);
}
```
Q: è¿™ä¸ªä»£ç çš„æ‰§è¡Œæµç¨‹ï¼Ÿ

A:

1. **è¿›æ¥æ—¶**ï¼šæ£€æŸ¥ writers == 0ï¼Œå¦åˆ™åœ¨ readersQ ç­‰å¾…ã€‚
    
2. **è¿›å…¥è¯»æ¨¡å¼**ï¼šreaders++ï¼Œå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¯»ã€‚
    
3. **ç¦»å¼€æ—¶**ï¼šreaders--ï¼Œå¦‚æœè¿™æ˜¯æœ€åä¸€ä¸ªè¯»è€…ï¼ˆreaders == 0ï¼‰ï¼Œå°±å”¤é†’ä¸€ä¸ªå†™è€…ã€‚
    

---

## **ğŸ”¹POSIX å®ç° Writer ä»£ç **

  

Q: Writer çš„å®ç°å¦‚ä½•ä¿è¯ç‹¬å ï¼Ÿ

A:
```
writer() {
  pthread_mutex_lock(&m);
  while (!((readers == 0) && (writers == 0)))
    pthread_cond_wait(&writersQ, &m);
  writers++;
  pthread_mutex_unlock(&m);

  /* write */

  pthread_mutex_lock(&m);
  writers--;
  pthread_cond_signal(&writersQ);
  pthread_cond_broadcast(&readersQ);
  pthread_mutex_unlock(&m);
}
```
å†™è€…å¿…é¡»ç­‰åˆ° **æ²¡æœ‰è¯»è€…ä¸”æ²¡æœ‰å…¶ä»–å†™è€…** æ‰èƒ½è¿›å…¥ã€‚
```
#### **1.**Â 

#### **pthread_mutex_lock(&m);**

- åŠ é”ï¼Œç¡®ä¿ä¸‹é¢çš„æ£€æŸ¥æ¡ä»¶å’Œä¿®æ”¹ writers çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œé¿å…å¤šä¸ª writer/reader å¹¶å‘ä¿®æ”¹å…±äº«å˜é‡ã€‚
    

---

#### **2.**Â 

#### **while (!((readers == 0) && (writers == 0))) pthread_cond_wait(&writersQ, &m);**

- **é€»è¾‘æ¡ä»¶**ï¼šå†™è€…åªæœ‰åœ¨ **æ²¡æœ‰è¯»è€…** ä¸” **æ²¡æœ‰å†™è€…** çš„æ—¶å€™æ‰èƒ½è¿›å…¥ã€‚
    
- å¦åˆ™å°±è¦è¿›å…¥ç­‰å¾…é˜Ÿåˆ— writersQã€‚
    
- pthread_cond_wait(&writersQ, &m)ï¼š
    
    1. è‡ªåŠ¨é‡Šæ”¾ mï¼ˆè®©åˆ«çš„çº¿ç¨‹è¿è¡Œï¼‰ã€‚
        
    2. æŠŠè‡ªå·±æŒ‚åˆ° writersQ é˜Ÿåˆ—ä¸Šï¼Œé˜»å¡ç­‰å¾…ã€‚
        
    3. è¢«å”¤é†’åä¼šé‡æ–°è·å¾—é” mï¼Œå†æ£€æŸ¥æ¡ä»¶ã€‚
        
    
- while æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå¯èƒ½ä¼šè¢«è™šå‡å”¤é†’ (spurious wakeup)ã€‚
    

---

#### **3.**Â 

#### **writers++;**

- æˆåŠŸè¿›å…¥å†™æ¨¡å¼åï¼ŒæŠŠ writers è®¾ä¸º 1ï¼Œè¡¨ç¤ºå½“å‰æœ‰å†™è€…åœ¨å†™ã€‚
    

---

#### **4.**Â 

#### **pthread_mutex_unlock(&m);**

- è§£é”ï¼Œè®©å…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­æ£€æŸ¥æ¡ä»¶ã€‚
    
- æ³¨æ„ï¼šå³ä½¿æ­¤æ—¶ writer æ­£åœ¨å†™ï¼Œè§£é”æ˜¯å®‰å…¨çš„ï¼Œå› ä¸º writers = 1 ä¼šé˜»æ­¢å…¶ä»–çº¿ç¨‹ï¼ˆè¯»è€…æˆ–å†™è€…ï¼‰è¿›å…¥ã€‚
    

---

#### **5.**Â 

#### **/* write */**

- å†™è€…å¯¹å…±äº«èµ„æºçš„çœŸæ­£å†™æ“ä½œã€‚
    
- å› ä¸ºå†™æ˜¯ç‹¬å çš„ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€æ®µæœŸé—´ï¼Œå…¶ä»–è¯»è€…å’Œå†™è€…éƒ½ä¼šè¢«é˜»å¡ã€‚
    

---

#### **6.**Â 

#### **pthread_mutex_lock(&m);**

- å†™å®Œåï¼Œè¦ä¿®æ”¹ writers--ï¼Œéœ€è¦é‡æ–°åŠ é”ï¼Œé¿å… race conditionã€‚
    

---

#### **7.**Â 

#### **writers--;**

- å†™è€…å®Œæˆå·¥ä½œï¼ŒæŠŠå†™è€…æ•°ç›®å‡ 1ï¼Œå˜å› 0ã€‚
    

---

#### **8.**Â 

#### **pthread_cond_signal(&writersQ);**

- å”¤é†’ **ä¸€ä¸ª**ç­‰å¾…çš„å†™è€…çº¿ç¨‹ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚
    
- è¿™æ ·å¯ä»¥è®©æ’é˜Ÿçš„å†™è€…ç»§ç»­æ‰§è¡Œã€‚
    

---

#### **9.**Â 

#### **pthread_cond_broadcast(&readersQ);**

- åŒæ—¶å”¤é†’æ‰€æœ‰è¯»è€…çº¿ç¨‹ï¼Œå› ä¸ºä¸€æ—¦æ²¡æœ‰å†™è€…äº†ï¼Œè¯»è€…å¯ä»¥å¹¶è¡Œè¿›å…¥ã€‚
    

---

#### **10.**Â 

#### **pthread_mutex_unlock(&m);**

- è§£é”ï¼Œé‡Šæ”¾å…±äº«å˜é‡æ§åˆ¶ã€‚
```

---

## **ğŸ”¹Starvation Problem (é¥¥é¥¿é—®é¢˜)**

  

Q: è¯»è€…â€“å†™è€…é—®é¢˜ä¸­ï¼Œå†™è€…å¯èƒ½è¢«é¥¿æ­»å—ï¼Ÿ

A: æ˜¯çš„ï¼Œå¦‚æœä¸€ç›´æœ‰æ–°çš„è¯»è€…è¿›æ¥ï¼Œå†™è€…å¯èƒ½æ°¸è¿œå¾—ä¸åˆ°æœºä¼šå†™ã€‚

  

Q: å¦‚ä½•è§£å†³å†™è€…é¥¥é¥¿ï¼Ÿ

A:

- ä¿®æ”¹é€»è¾‘ï¼šä¸€æ—¦æœ‰å†™è€…åˆ°è¾¾ï¼Œé˜»æ­¢æ–°çš„è¯»è€…è¿›å…¥ï¼Œç›´åˆ°å†™è€…å®Œæˆã€‚
    
- ä½¿ç”¨ active_writers æ¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª writer çœŸæ­£å†™ã€‚
    

---

## **ğŸ”¹POSIX è¯»å†™é” (pthread_rwlock)**

  

Q: POSIX æä¾›çš„è¯»å†™é” API æœ‰å“ªäº›ï¼Ÿ

A:

- åˆå§‹åŒ–ä¸é”€æ¯ï¼š
```
 pthread_rwlock_init, pthread_rwlock_destroy
```
- åŠ é”ä¸è§£é”ï¼š
```
pthread_rwlock_rdlock, pthread_rwlock_wrlock, pthread_rwlock_unlock
```
- éé˜»å¡ä¸å®šæ—¶ï¼š
```
pthread_rwlock_tryrdlock, pthread_rwlock_trywrlock
pthread_rwlock_timedrdlock, pthread_rwlock_timedwrlock
```
## **ğŸ”¹Barriers (å±éšœ)**

  

Q: ä»€ä¹ˆæ˜¯ barrierï¼Ÿ

A: å±éšœæ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œè¦æ±‚å¤šä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾æŸä¸ªç‚¹åï¼Œæ‰èƒ½ä¸€èµ·ç»§ç»­æ‰§è¡Œã€‚

  

Q: POSIX barrier APIï¼Ÿ

A:
```
pthread_barrier_init, pthread_barrier_destroy, pthread_barrier_wait
```
Q: Barrier çš„åº”ç”¨ä¾‹å­ï¼Ÿ

A: Fork-join æ¨¡å‹ï¼šå¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œç­‰åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½å®Œæˆï¼Œä¸»çº¿ç¨‹æ‰èƒ½ç»§ç»­ã€‚

---
### **çº¿ç¨‹å®‰å…¨ (Thread Safety)**

- **Q: ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼Ÿ**
    
    - **A:** çº¿ç¨‹å®‰å…¨æŒ‡çš„æ˜¯è®©é‚£äº›åœ¨è®¾è®¡æ—¶æœªè€ƒè™‘çº¿ç¨‹é—®é¢˜çš„åº“å‡½æ•°ï¼Œèƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨åœ°è¿è¡Œ ã€‚ç”±äº Unix æ˜¯åœ¨çº¿ç¨‹æ™®åŠä¹‹å‰å¼€å‘çš„ï¼Œå…¶è®¸å¤šåº“å‡½æ•°æœ¬èº«å¹¶éçº¿ç¨‹å®‰å…¨çš„ ã€‚
        
- **Q: æ—§ç‰ˆ Unix API å­˜åœ¨å“ªäº›çº¿ç¨‹ä¸å®‰å…¨çš„é—®é¢˜ï¼Ÿ**
    
    - **A:**
        
        - **å…¨å±€å˜é‡**: ä¾‹å¦‚ `errno`ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­åŒæ—¶è°ƒç”¨å¹¶éƒ½å¤±è´¥æ—¶ï¼Œæ— æ³•ä¿è¯çº¿ç¨‹è·å–åˆ°æ­£ç¡®çš„é”™è¯¯ç  ã€‚
            
        - **å…±äº«æ•°æ®**: ä¾‹å¦‚ `printf()`ï¼Œå¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨å¯èƒ½ä¼šå¯¼è‡´è¾“å‡ºäº¤é”™æ··ä¹± ã€‚
            
- **Q: `errno` çš„çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜æœ‰ä»€ä¹ˆå…·ä½“çš„ä»£ç ç¤ºä¾‹å—ï¼Ÿ**
    
    - **A:** åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ `IOfunc` å¹¶ä¸” `write` éƒ½å¤±è´¥äº†ï¼Œåä¸€ä¸ªçº¿ç¨‹è®¾ç½®çš„ `errno` å¯èƒ½ä¼šè¦†ç›–å‰ä¸€ä¸ªçº¿ç¨‹çš„ `errno`ï¼Œå¯¼è‡´å‰ä¸€ä¸ªçº¿ç¨‹è¯»å–åˆ°é”™è¯¯çš„é”™è¯¯ç  

```
int IOfunc(int fd) {
    extern int errno;
    if (write(fd, buffer, size) == -1) {
        if (errno == EIO)
            ...
    }
    ...
}
```
- **Q: å¤šçº¿ç¨‹ä½¿ç”¨ `printf()` ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ**
    
    - **A:** ä¸¤ä¸ªçº¿ç¨‹çš„è¾“å‡ºå¯èƒ½ä¼šæ··åˆåœ¨ä¸€èµ·ï¼Œå¯¼è‡´å†…å®¹é”™ä¹± ã€‚ä¾‹å¦‚ï¼š
        
        - çº¿ç¨‹ 1 æ‰§è¡Œ:
            
            `printf("goto statement reached");`
            
        - çº¿ç¨‹ 2 æ‰§è¡Œ:
            
            `printf("Hello World\n");`
            
        - æœ€ç»ˆå¯èƒ½å¾—åˆ°çš„è¾“å‡ºæ˜¯:
            
            `goto Hello Wostatement reachedrld`
            

### **çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•**

- **Q: å¦‚ä½•è§£å†³ `errno` çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ**
    
    - **A:** POSIX é€šè¿‡æä¾›çº¿ç¨‹ç§æœ‰æ•°æ®å­˜å‚¨æœºåˆ¶æ¥è§£å†³ ã€‚é€šè¿‡å°†
        
        `errno` å®šä¹‰ä¸ºæŒ‡å‘æ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹çš„å­˜å‚¨ä½ç½®ï¼Œç¡®ä¿æ¯ä¸ªçº¿ç¨‹è®¿é—®è‡ªå·±çš„ `errno` å‰¯æœ¬ ã€‚è¿™æ ·æ— éœ€ä¿®æ”¹åº”ç”¨ç¨‹åºä»£ç ï¼Œåªéœ€é‡æ–°ç¼–è¯‘å³å¯ ã€‚
        
- **Q: å¯¹äºè¿”å›å…¨å±€æ•°æ®çš„å‡½æ•°ï¼Œå¦‚ä½•ä½¿å…¶çº¿ç¨‹å®‰å…¨ï¼Ÿ**
    
    - **A:** æ·»åŠ ä¸€ä¸ªâ€œå¯é‡å…¥â€(`_r`)ç‰ˆæœ¬ ã€‚ä¾‹å¦‚ï¼Œéçº¿ç¨‹å®‰å…¨çš„
        
        `gethostbyname()` è¿”å›ä¸€ä¸ªæŒ‡å‘å…¨å±€å˜é‡çš„æŒ‡é’ˆ ï¼Œè€Œ POSIX æä¾›äº†
        
        `gethostbyname_r()` ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬è¦æ±‚è°ƒç”¨è€…è‡ªè¡Œæä¾›ç”¨äºå­˜å‚¨è¿”å›æ•°æ®çš„ç¼“å†²åŒºï¼Œä»è€Œè§£å†³äº†å…±äº«å…¨å±€æ•°æ®çš„é—®é¢˜ ã€‚
        
    - **éçº¿ç¨‹å®‰å…¨ç‰ˆæœ¬:**
        
        C
        
        ```
        struct hostent *gethostbyname(const char *name)
        ```
        
    - **çº¿ç¨‹å®‰å…¨çš„å¯é‡å…¥ç‰ˆæœ¬:**
        
        C
        
        ```
        int gethostbyname_r(const char *name,
                            struct hostent *ret,
                            char *buf,
                            size_t buflen,
                            struct hostent **result,
                            int *h_errnop)
        ```
        
- **Q: å¦‚ä½•è§£å†³ `printf()` è¿™ç±»å‡½æ•°çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ**
    
    - **A:** å¯ä»¥ä½¿ç”¨åŒæ­¥æœºåˆ¶æ¥åŒ…è£…åº“å‡½æ•° ã€‚ä¾‹å¦‚ï¼Œå¯¹äº C æ ‡å‡† I/O åº“ä¸­çš„
        
        `FILE*` å¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°æ¥åŠ é”å’Œè§£é”ï¼Œä»¥ä¿æŠ¤ `printf()` è¿™æ ·çš„è°ƒç”¨ ï¼š
        
        C
        
        ```
        void flockfile(FILE *filehandle)
        int ftrylockfile(FILE *filehandle)
        void funlockfile(FILE *filehandle)
        ```
        

### **çº¿ç¨‹çš„å®šæ—¶ä¸ç­‰å¾…**

- **Q: çº¿ç¨‹å¦‚ä½•è¿›è¡Œå»¶æ—¶æˆ–ç­‰å¾…ï¼Ÿ**
    
    - **A:**
        
        - **`nanosleep()`**: å¯ä»¥è®©çº¿ç¨‹æŒ‚èµ·ä¸€æ®µæŒ‡å®šçš„æ—¶é—´ ï¼Œä½†è¿™æ˜¯ä¸€ç§â€œå°½åŠ›è€Œä¸ºâ€çš„æœºåˆ¶ ã€‚
            
            C
            
            ```
            struct timespec timeout, remaining_time;
            timeout.tv_sec = 3;         // seconds
            timeout.tv_nsec = 1000;     // nanoseconds
            nanosleep(&timeout, &remaining_time);
            ```
            
        - **`pthread_cond_timedwait()`**: æ˜¯ä¸€ç§æ›´ç²¾ç¡®çš„ç­‰å¾…æ–¹å¼ï¼Œå®ƒå…è®¸çº¿ç¨‹ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–è¶…è¿‡ä¸€ä¸ªæŒ‡å®šçš„**ç»å¯¹æ—¶é—´ç‚¹** (`abstime`) ã€‚
            
            C
            
            ```
            // abstime éœ€è¦é€šè¿‡å½“å‰æ—¶é—´åŠ ä¸Šç›¸å¯¹çš„è¶…æ—¶æ—¶é—´æ¥è®¡ç®—
            struct timespec absolute_timeout;
            ... // è®¡ç®— absolute_timeout
            pthread_mutex_lock(&m);
            while (!may_continue)
                pthread_cond_timedwait(&cv, &m, &absolute_timeout);
            pthread_mutex_unlock(&m);
            ```
            

### **çº¿ç¨‹çš„å¼‚å¸¸ä¸ä¿¡å· (Signal)**

- **Q: ä»€ä¹ˆæ˜¯ä¿¡å· (Signal)ï¼Ÿ**
    
    - **A:** ä¿¡å·æ˜¯ä¸€ç§æ“ä½œç³»ç»Ÿæä¾›çš„â€œå›è°ƒæœºåˆ¶â€ æˆ–â€œè½¯ä»¶ä¸­æ–­â€ ã€‚å®ƒç”¨äºå“åº”å¼‚å¸¸ï¼ˆå¦‚ç®—æœ¯é”™è¯¯ ï¼‰ã€å¤–éƒ¨äº‹ä»¶ï¼ˆå¦‚å®šæ—¶å™¨åˆ°æœŸã€é”®ç›˜è¾“å…¥ ï¼‰æˆ–ç”¨æˆ·è‡ªå®šä¹‰äº‹ä»¶ ã€‚ä¾‹å¦‚ï¼Œé™¤ä»¥é›¶çš„æ“ä½œä¼šäº§ç”Ÿä¸€ä¸ªä¿¡å· ã€‚
        
        C
        
        ```
        int x, y;
        x = 0;
        ...
        y = 16 / x; // è¿™ä¼šäº§ç”Ÿä¸€ä¸ªä¿¡å·
        ```
        
- **Q: å¦‚ä½•å‘è¿›ç¨‹æˆ–çº¿ç¨‹å‘é€ä¿¡å·ï¼Ÿ**
    
    - **A:**
        
        - **`kill(pid_t pid, int sig)`**: å‘é€ä¸€ä¸ªæŒ‡å®šçš„ä¿¡å·ç»™æŸä¸ªè¿›ç¨‹ ã€‚
            
        - **`pthread_kill(pthread_t thr, int sig)`**: åœ¨åŒä¸€è¿›ç¨‹å†…ï¼Œå‘é€ä¿¡å·ç»™æŒ‡å®šçš„çº¿ç¨‹ ã€‚ä¸è¿‡ï¼Œè‹¥è¦ç»ˆæ­¢çº¿ç¨‹ï¼Œæ¨èä½¿ç”¨ POSIX çš„å–æ¶ˆæœºåˆ¶ (cancellation mechanism) ã€‚


---
å¥½çš„ ğŸ‘ï¼Œæˆ‘æ¥å¸®ä½ æ¢³ç† **lecture7-slides2.pdf** çš„æ–°å†…å®¹ï¼Œå¹¶ç»“åˆæˆ‘ä»¬ä¹‹å‰çš„é£æ ¼è§£é‡Šç»†è‡´ä¸€äº›ï¼š

---

### **ğŸ”¹Thread Safety**

- **èƒŒæ™¯**
    
    Unix æœ€æ—©è®¾è®¡æ—¶æ²¡æœ‰çº¿ç¨‹çš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„åº“å‡½æ•°éƒ½æ˜¯é»˜è®¤å•çº¿ç¨‹ç¯å¢ƒã€‚åæ¥å¤šçº¿ç¨‹æµè¡Œèµ·æ¥åï¼Œè¿™äº›åº“å‡½æ•°åœ¨å¤šçº¿ç¨‹ä¸‹å°±å˜å¾—ä¸å®‰å…¨äº†ã€‚
    
- **é—®é¢˜**
    
    æ¯”å¦‚å…¨å±€å˜é‡ errnoï¼Œæˆ–è€… printf ä¸­å…±äº«çš„ bufferã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ï¼Œå°±å¯èƒ½å‡ºç°æ•°æ®æ··ä¹±ã€‚
    
- **è§£å†³**
    
    - æ”¹å†™åº“å‡½æ•° â†’ æ”¯æŒçº¿ç¨‹å®‰å…¨
        
    - ç”¨åŒæ­¥æœºåˆ¶ï¼ˆmutex ç­‰ï¼‰åŒ…è£…è€å‡½æ•°
        
    

---

### **ğŸ”¹Thread Safety vs. Reentrancy**

- **Thread-safe**: å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶è°ƒç”¨å‡½æ•°ï¼Œè€Œä¸ä¼šäº’ç›¸å½±å“ã€‚
    
- **Reentrant**: å³ä½¿å‡½æ•°åœ¨æ‰§è¡Œä¸­è¢«æ‰“æ–­ï¼ˆä¾‹å¦‚ä¿¡å·æˆ–ä¸­æ–­ï¼‰ï¼Œå†æ¬¡è¿›å…¥ä¹Ÿèƒ½å®‰å…¨æ‰§è¡Œã€‚
    
- äºŒè€…ä¸åŒï¼Œä½†å¾ˆå¤šæ—¶å€™ **çº¿ç¨‹å®‰å…¨**å’Œ**å¯é‡å…¥**æœ€ç»ˆéƒ½è¦æ±‚ç±»ä¼¼çš„æªæ–½ã€‚
    

---

### **ğŸ”¹Global Variables é—®é¢˜**

- errno æ˜¯å…¨å±€å˜é‡ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹å‡ ä¹åŒæ—¶è°ƒç”¨å¤±è´¥çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šè¦†ç›–å¦ä¸€ä¸ªçš„ errnoã€‚
    
- **ç»“æœ**: æŸä¸ªçº¿ç¨‹è¯»åˆ°çš„é”™è¯¯ç å¯èƒ½ä¸æ˜¯å®ƒè‡ªå·±çš„ã€‚
    

---

### **ğŸ”¹è§£å†³æ–¹æ¡ˆ**

1. **çº¿ç¨‹ç§æœ‰æ•°æ® (Thread-specific data, TSD)**
    
    - POSIX æä¾›äº†æœºåˆ¶ï¼Œè®©æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„ errnoã€‚
        
    - ç±»ä¼¼ #define errno __errno(thread_ID)ï¼Œæ¯ä¸ªçº¿ç¨‹è®¿é—®åˆ°çš„æ˜¯å±äºè‡ªå·±çš„é‚£ä»½ã€‚
        
    - Windows é‡Œå« **thread-local storage (TLS)**ã€‚
        
    
2. **Reentrant ç‰ˆæœ¬ API**
    
    - ä¾‹å¦‚ gethostbyname() åŸæœ¬è¿”å›ä¸€ä¸ªæŒ‡å‘å…¨å±€å˜é‡çš„æŒ‡é’ˆï¼ˆä¸å®‰å…¨ï¼‰ã€‚
        
    - POSIX æä¾›äº† gethostbyname_r()ï¼Œè®©è°ƒç”¨è€…è‡ªå·±æä¾› buffer å­˜æ”¾è¿”å›ç»“æœ â†’ é¿å…å…±äº«æ•°æ®ã€‚
        
    

---

### **ğŸ”¹Shared Data é—®é¢˜**

- å¤šçº¿ç¨‹åŒæ—¶ printfï¼Œå¯èƒ½å¯¼è‡´è¾“å‡ºäº¤é”™ï¼š
    

```
goto Hello Wostatement reachedrld
```

-   
    
- **è§£å†³**: ç”¨ flockfile(FILE*) ç­‰å‡½æ•°å¯¹ FILE* ä¸Šé”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å†™ã€‚
    

---

### **ğŸ”¹Sleeping å’Œ Timeout**

- **nanosleep()**: å¯ä»¥æŒ‡å®šä¼‘çœ æ—¶é—´ã€‚
    
- **pthread_cond_timedwait()**:
    
    - å¯ä»¥åœ¨ç­‰å¾…æ¡ä»¶å˜é‡æ—¶è®¾ç½®è¶…æ—¶æ—¶é—´ã€‚
        
    - è¶…æ—¶åè¿”å›é”™è¯¯ç ï¼ˆä¸æ˜¯æ— é™ç­‰ï¼‰ã€‚
        
    

---

### **ğŸ”¹Deviations: ä¿¡å·å’Œçº¿ç¨‹å–æ¶ˆ**

- **Unix signal**ï¼šæœ€åˆè®¾è®¡ç”¨æ¥ä¼˜é›…ç»ˆæ­¢è¿›ç¨‹ï¼Œä¾‹å¦‚ <Ctrl+C>ã€‚
    
- **ç”¨é€”**:
    
    - å¼‚å¸¸ï¼ˆé™¤é›¶ã€éæ³•å†…å­˜è®¿é—®ç­‰ï¼‰
        
    - å¤–éƒ¨äº‹ä»¶ï¼ˆå®šæ—¶å™¨ã€é”®ç›˜è¾“å…¥ï¼‰
        
    - æ€æ­»æˆ–æš‚åœè¿›ç¨‹
        
    
- **ä¿¡å·å’Œä¸­æ–­ç±»ä¼¼**ï¼šå¯ä»¥é˜»å¡ã€è§£é™¤é˜»å¡ã€æŒ‚èµ·ã€æ¢å¤ã€‚
    
- **çº¿ç¨‹**ï¼šæœ‰ pthread_kill() å‘é€ä¿¡å·ç»™çº¿ç¨‹ï¼Œä½†æ¨èç”¨ **pthread cancellation** ä»£æ›¿ã€‚
    

---

### **ğŸ”¹ä¿¡å·çš„çŠ¶æ€**

- **pending**: ä¿¡å·å·²ç»äº§ç”Ÿï¼Œä½†è¢«é˜»å¡ï¼Œè¿˜æ²¡è¢«ä¼ é€’ã€‚
    
- **delivered**: ä¸€æ—¦è§£é™¤é˜»å¡ï¼Œç«‹å³ä¼ é€’ã€‚
    
- ç±»ä¼¼ CPU ç¡¬ä»¶ä¸­æ–­çš„ â€œdisable/enableâ€ã€‚
    
---
